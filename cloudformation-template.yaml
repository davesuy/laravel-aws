AWSTemplateFormatVersion: '2010-09-09'
Description: 'Laravel Application Stack - Free Tier Demo (t3.micro with Ubuntu 22.04 LTS)'

Parameters:
  AmiId:
    Type: AWS::EC2::Image::Id
    Default: ami-01fd6fa49060e89a6
    Description: "AMI ID for Ubuntu 22.04 LTS"

  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: "EC2 Key Pair for SSH access"

  InstanceType:
    Type: String
    Default: t3.micro
    AllowedValues:
      - t2.micro
      - t3.micro
    Description: "EC2 instance type (Free Tier eligible)"

  SSHLocation:
    Type: String
    Default: 0.0.0.0/0
    Description: "IP address range that can SSH to the EC2 instance"
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: "Must be a valid IP CIDR range of the form x.x.x.x/x"

Resources:
  # VPC Configuration
  LaravelVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-VPC'

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-IGW'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref LaravelVPC
      InternetGatewayId: !Ref InternetGateway

  # Public Subnet
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref LaravelVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PublicSubnet'

  # Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref LaravelVPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-PublicRouteTable'

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Security Group
  LaravelSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-SecurityGroup'
      GroupDescription: 'Security group for Laravel application'
      VpcId: !Ref LaravelVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
          Description: 'SSH access'
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: 'HTTP access'
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: 'HTTPS access'
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          CidrIp: 0.0.0.0/0
          Description: 'Laravel development server'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: 'Allow all outbound traffic'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-SecurityGroup'

  # IAM Role for EC2
  LaravelEC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-EC2Role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-EC2Role'

  # Instance Profile
  LaravelInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${AWS::StackName}-InstanceProfile'
      Roles:
        - !Ref LaravelEC2Role

  # EC2 Instance
  LaravelEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref AmiId
      KeyName: !Ref KeyPairName
      IamInstanceProfile: !Ref LaravelInstanceProfile
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: '0'
          GroupSet:
            - !Ref LaravelSecurityGroup
          SubnetId: !Ref PublicSubnet
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 30
            VolumeType: gp3
            DeleteOnTermination: true
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -e

          # Update system
          apt-get update
          apt-get upgrade -y

          # Install required packages
          apt-get install -y \
            nginx \
            php8.1-fpm \
            php8.1-cli \
            php8.1-common \
            php8.1-mysql \
            php8.1-xml \
            php8.1-curl \
            php8.1-mbstring \
            php8.1-zip \
            php8.1-bcmath \
            php8.1-sqlite3 \
            mysql-server \
            git \
            unzip \
            curl \
            supervisor

          # Install Composer
          curl -sS https://getcomposer.org/installer | php
          mv composer.phar /usr/local/bin/composer
          chmod +x /usr/local/bin/composer

          # Install Node.js and npm
          curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
          apt-get install -y nodejs

          # Create application directory
          mkdir -p /var/www/laravel

          # Configure Nginx
          cat > /etc/nginx/sites-available/laravel << 'EOF'
          server {
              listen 80;
              listen [::]:80;
              server_name _;
              root /var/www/laravel/public;

              add_header X-Frame-Options "SAMEORIGIN";
              add_header X-Content-Type-Options "nosniff";

              index index.php;

              charset utf-8;

              location / {
                  try_files $uri $uri/ /index.php?$query_string;
              }

              location = /favicon.ico { access_log off; log_not_found off; }
              location = /robots.txt  { access_log off; log_not_found off; }

              error_page 404 /index.php;

              location ~ \.php$ {
                  fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
                  include fastcgi_params;
              }

              location ~ /\.(?!well-known).* {
                  deny all;
              }
          }
          EOF

          # Enable Nginx site
          ln -sf /etc/nginx/sites-available/laravel /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default

          # Set proper permissions
          chown -R www-data:www-data /var/www/laravel
          chmod -R 755 /var/www/laravel

          # Restart services
          systemctl restart nginx
          systemctl restart php8.1-fpm
          systemctl enable nginx
          systemctl enable php8.1-fpm

          # Create deployment script
          cat > /home/ubuntu/deploy-laravel.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          cd /var/www/laravel

          # Pull latest code (if using git)
          # git pull origin main

          # Install dependencies
          composer install --no-dev --optimize-autoloader
          npm install
          npm run build

          # Laravel setup
          php artisan key:generate
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          php artisan migrate --force

          # Set permissions
          chown -R www-data:www-data /var/www/laravel
          chmod -R 755 /var/www/laravel
          chmod -R 775 /var/www/laravel/storage
          chmod -R 775 /var/www/laravel/bootstrap/cache

          # Restart services
          systemctl restart nginx
          systemctl restart php8.1-fpm
          DEPLOY_SCRIPT

          chmod +x /home/ubuntu/deploy-laravel.sh
          chown ubuntu:ubuntu /home/ubuntu/deploy-laravel.sh

          # Create a simple info file
          echo "Laravel Demo Server Ready - $(date)" > /var/www/html/info.txt
          echo "CloudFormation Stack: ${AWS::StackName}" >> /var/www/html/info.txt

      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-LaravelServer'
        - Key: Application
          Value: Laravel
        - Key: Environment
          Value: Demo

Outputs:
  InstanceId:
    Description: 'EC2 Instance ID'
    Value: !Ref LaravelEC2Instance
    Export:
      Name: !Sub '${AWS::StackName}-InstanceId'

  PublicIP:
    Description: 'Public IP address of the EC2 instance'
    Value: !GetAtt LaravelEC2Instance.PublicIp
    Export:
      Name: !Sub '${AWS::StackName}-PublicIP'

  PublicDNS:
    Description: 'Public DNS name of the EC2 instance'
    Value: !GetAtt LaravelEC2Instance.PublicDnsName
    Export:
      Name: !Sub '${AWS::StackName}-PublicDNS'

  WebsiteURL:
    Description: 'URL to access the Laravel application'
    Value: !Sub 'http://${LaravelEC2Instance.PublicIp}'

  SSHCommand:
    Description: 'SSH command to connect to the instance'
    Value: !Sub 'ssh -i "your-key.pem" ubuntu@${LaravelEC2Instance.PublicIp}'

  DeploymentInstructions:
    Description: 'Next steps for deployment'
    Value: !Sub |
      1. SSH into the instance: ssh -i "your-key.pem" ubuntu@${LaravelEC2Instance.PublicIp}
      2. Copy your Laravel code to /var/www/laravel
      3. Run the deployment script: sudo /home/ubuntu/deploy-laravel.sh

